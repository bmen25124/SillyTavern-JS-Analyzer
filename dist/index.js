(()=>{"use strict";var e={508:e=>{e.exports=require("tree-sitter")},660:e=>{e.exports=require("tree-sitter-javascript")},746:function(e,t,o){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.JavaScriptSecurityAnalyzer=void 0;const r=s(o(508)),n=s(o(660));t.JavaScriptSecurityAnalyzer=class{parser;dangerousAPIs;dangerousConstructors;settings;constructor(e){this.parser=new r.default,this.parser.setLanguage(n.default),this.settings={allowedAPIs:["console","Math","Date","JSON","parseInt","parseFloat","isNaN","isFinite"],blockedAPIs:["fetch","XMLHttpRequest","eval","Function","WebSocket","localStorage","sessionStorage"],maxScriptLength:5e4,allowObfuscation:!1,debugMode:!1,...e},this.dangerousAPIs=new Set([...this.settings.blockedAPIs,"indexedDB","navigator.sendBeacon","navigator.geolocation","navigator.getUserMedia","window.open","window.location","document.cookie","document.domain","import","require","importScripts","postMessage"]),this.dangerousConstructors=new Set(["XMLHttpRequest","WebSocket","Function","Worker","SharedWorker","ServiceWorker","EventSource","WebRTC","AudioContext"])}updateSettings(e){this.settings={...this.settings,...e},this.dangerousAPIs=new Set([...this.settings.blockedAPIs,"indexedDB","navigator.sendBeacon","navigator.geolocation","navigator.getUserMedia","window.open","window.location","document.cookie","document.domain","import","require","importScripts","postMessage"])}analyzeScript(e){const t=[];try{if(e.length>this.settings.maxScriptLength)return t.push({type:"script_too_large",node:"script",position:{row:0,column:0},severity:"error",message:`Script exceeds maximum allowed length (${this.settings.maxScriptLength} characters)`}),{safe:!1,violations:t};const o=this.parser.parse(e);this.walkTree(o.rootNode,t,e),this.checkObfuscation(e,t);const s=this.sanitizeCode(e,t);return t.some((e=>"error"===e.severity))?{safe:!1,violations:t,sanitizedCode:s}:{safe:!0,violations:t,sanitizedCode:s}}catch(e){return t.push({type:"parse_error",node:"root",position:{row:0,column:0},severity:"error",message:`Failed to parse JavaScript: ${e instanceof Error?e.message:"Unknown error"}`}),{safe:!1,violations:t}}}walkTree(e,t,o,s=0){this.getASTDebugInfo(o);if(this.settings.debugMode&&console.log(this.prettyPrintNode(e,o,s)),"ERROR"===e.type&&t.push({type:"parse_error",node:"syntax_error",position:{row:e.startPosition.row,column:e.startPosition.column},severity:"error",message:"Invalid JavaScript syntax detected"}),"call_expression"===e.type){const s=this.getCalleeText(e,o);this.isDangerousAPI(s)&&t.push({type:"dangerous_api_call",node:s,position:{row:e.startPosition.row,column:e.startPosition.column},severity:"error",message:`Blocked dangerous API call: ${s}`}),("eval"===s||s.includes("eval"))&&t.push({type:"dynamic_evaluation",node:s,position:{row:e.startPosition.row,column:e.startPosition.column},severity:"error",message:"Dynamic code evaluation is not allowed"})}if("member_expression"===e.type&&"call_expression"!==e.parent?.type){const s=this.getMemberText(e,o);this.isDangerousAPI(s)&&t.push({type:"dangerous_member_access",node:s,position:{row:e.startPosition.row,column:e.startPosition.column},severity:"error",message:`Blocked dangerous member access: ${s}`})}if("new_expression"===e.type){const s=this.getConstructorText(e,o);this.dangerousConstructors.has(s)&&t.push({type:"dangerous_constructor",node:s,position:{row:e.startPosition.row,column:e.startPosition.column},severity:"error",message:`Blocked dangerous constructor: ${s}`})}if("assignment_expression"===e.type){const s=this.getAssignmentTarget(e,o);s&&this.isDangerousAssignment(s)&&t.push({type:"dangerous_assignment",node:s,position:{row:e.startPosition.row,column:e.startPosition.column},severity:"error",message:`Blocked dangerous assignment: ${s}`})}for(let r=0;r<e.childCount;r++)this.walkTree(e.child(r),t,o,s+1)}checkObfuscation(e,t){if(this.settings.allowObfuscation)return;[/\\x[0-9a-fA-F]{2}/,/\\u[0-9a-fA-F]{4}/,/String\.fromCharCode/,/atob|btoa/,/unescape|escape/].forEach(((o,s)=>{o.test(e)&&t.push({type:"obfuscation_detected",node:"obfuscated_code",position:{row:0,column:0},severity:"error",message:`Obfuscation detected and blocked (pattern ${s+1})`})}))}getCalleeText(e,t){return e.firstChild?"identifier"===e.firstChild.type?t.slice(e.firstChild.startIndex,e.firstChild.endIndex):"member_expression"===e.firstChild.type?this.getMemberText(e.firstChild,t):"":""}getMemberText(e,t){if(e.childCount<3)return"";const o=e.child(0),s=e.child(2);if(!o||!s)return"";return`${t.slice(o.startIndex,o.endIndex)}.${t.slice(s.startIndex,s.endIndex)}`}getConstructorText(e,t){if(e.childCount<2)return"";const o=e.child(1);return o?t.slice(o.startIndex,o.endIndex):""}getAssignmentTarget(e,t){return e.firstChild?t.slice(e.firstChild.startIndex,e.firstChild.endIndex):""}isDangerousAPI(e){if(this.dangerousAPIs.has(e))return!0;const t=e.split(".")[0];if(this.dangerousAPIs.has(t))return!0;const o=e.split(".").pop()||"";return!!this.dangerousAPIs.has(o)||(e.includes("eval")||e.includes("Function"))}isDangerousAssignment(e){return["window.location","document.location","location.href","document.cookie","document.domain"].some((t=>e.includes(t)))}sanitizeCode(e,t){let o=e;return t.filter((e=>"error"===e.severity)).sort(((e,t)=>t.position.row-e.position.row||t.position.column-e.position.column)).forEach((e=>{const t=this.getSafeReplacement(e.node),s=e.node.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");o=o.replace(new RegExp(`\\b${s}\\b`,"g"),t)})),o}getSafeReplacement(e){return{fetch:"/* fetch() blocked for security */",XMLHttpRequest:"/* XMLHttpRequest blocked for security */",eval:"/* eval() blocked for security */",setTimeout:"/* setTimeout() blocked for security */",setInterval:"/* setInterval() blocked for security */",localStorage:"/* localStorage blocked for security */",sessionStorage:"/* sessionStorage blocked for security */","window.location":"/* window.location blocked for security */","document.cookie":"/* document.cookie blocked for security */","window.open":"/* window.open() blocked for security */"}[e]||`/* ${e} blocked for security */`}prettyPrintNode(e,t,o=0){const s="  ".repeat(o),r=t.slice(e.startIndex,e.endIndex),n=r.length>50?r.substring(0,50)+"...":r,i=[`${s}Node Type: ${e.type}`,`${s}Start Index: ${e.startIndex}`,`${s}End Index: ${e.endIndex}`,`${s}Position: ${e.startPosition.row}:${e.startPosition.column} - ${e.endPosition.row}:${e.endPosition.column}`,`${s}Text: "${n.replace(/\n/g,"\\n")}"`,`${s}Child Count: ${e.childCount}`];return e.isNamed&&i.push(`${s}Named: true`),e.hasError&&i.push(`${s}Has Error: true`),e.isMissing&&i.push(`${s}Missing: true`),i.push(`${s}---`),i.join("\n")}getASTDebugInfo(e){if(!this.settings.debugMode)return"Debug mode is disabled. Enable debugMode in settings to see AST information.";try{const t=this.parser.parse(e),o=["=== AST Pretty Print ==="];return this.collectNodeInfo(t.rootNode,e,o),o.join("\n")}catch(e){return`Error parsing code: ${e instanceof Error?e.message:"Unknown error"}`}}collectNodeInfo(e,t,o,s=0){o.push(this.prettyPrintNode(e,t,s));for(let r=0;r<e.childCount;r++)this.collectNodeInfo(e.child(r),t,o,s+1)}}}},t={};function o(s){var r=t[s];if(void 0!==r)return r.exports;var n=t[s]={exports:{}};return e[s].call(n.exports,n,n.exports,o),n.exports}var s={};(()=>{var e=s;const t=o(746);e.default={init:async function(e){e.post("/analyze",((e,o)=>{try{const{code:s,settings:r}=e.body;if(!s||"string"!=typeof s)return o.status(400).json({error:'Missing or invalid "code" parameter. Expected a string.'});const n=new t.JavaScriptSecurityAnalyzer;r&&"object"==typeof r&&n.updateSettings(r);const i=n.analyzeScript(s);return o.json(i)}catch(e){return console.error("Error analyzing JavaScript code:",e),o.status(500).json({error:"Internal server error during analysis",details:e instanceof Error?e.message:"Unknown error"})}}))},exit:()=>{},info:{id:"js-security",name:"JS Security",description:"Utility endpoint for JS Security plugin"}}})();var r=exports,n=s.default;for(var i in n)r[i]=n[i];n.__esModule&&Object.defineProperty(r,"__esModule",{value:!0})})();